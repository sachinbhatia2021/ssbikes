<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="refresh" content="150">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="icon" type="image/x-icon" href="/static/logo.jpeg">
  <title>Inverter Analytics</title>
  <style>
    .battery-container {
      position: relative;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background-color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 50px auto;
    }

    .battery-inner {
      position: absolute;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background-color: #fff;
      z-index: 1;
    }

    .battery-text {
      position: absolute;
      color: #000;
      font-size: 24px;
      font-weight: bold;
      z-index: 2;
    }

    .battery-overlay {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: conic-gradient(green 0deg, green calc(3.6deg * var(--battery-level)), #222 calc(3.6deg * var(--battery-level)), #222 360deg);
      animation: shake 2s infinite;
    }

    @keyframes shake {
      0% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(2px);
      }

      100% {
        transform: translateY(0);
      }
    }

    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #f5f7fa;
      overflow-x: hidden;
      transition: 0.5s;
      padding-top: 60px;
    }

    .sidenav a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 20px;
      color: #818181;
      display: block;
      transition: 0.3s;
    }

    .sidenav a:hover {
      color: #0e0707;
    }

    .sidenav .closebtn {
      position: absolute;
      top: 0;
      right: 25px;
      font-size: 36px;
      margin-left: 50px;
    }

    #main {
      transition: margin-left .5s;
      padding: 16px;
    }

    @media screen and (max-height: 450px) {
      .sidenav {
        padding-top: 15px;
      }

      .sidenav a {
        font-size: 18px;
      }
    }

    .nav {
      height: 60px;
      width: 100%;
      float: left;
      background-color: #f5f7fa;
      position: fixed;
      top: 0;
      z-index: 10;
      display: flex;
      flex-direction: row;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0px 0px 5px 5px rgba(0, 0, 0, 0.1);

    }

    li {
      display: inline-flex;
      float: right-reverse;
    }

    .logo {
      height: auto;
      width: 50px;
      padding-left: 10px;
      padding-right: 10px;
    }

    .nav a {
      display: flex;
      align-items: center;
      color: blue;
      text-decoration: none;
    }

    .nav ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    .nav ul li {
      display: inline-block;
      margin-left: 10px;
      padding-right: 15px;
    }

    li a.ex2:hover,
    a.ex2:active {
      height: 60px;
      width: 100%;
    }

    li a:hover:not(.active) {
      background-color: #5bcefc;
      color: white;
      padding: 5px;
      border-radius: 5px;
    }

    .nav .name a {
      margin-left: 45px;
      font-size: 20px;
      top: 15px;
      color: #043585;
      float: left;
      position: absolute;
      left: 0;
    }


    .con_small {
      padding: 10px;
      display: flex;
      flex-direction: row;
      margin-top: 30px;
      justify-content: space-between;

    }

    .half-width {
      width: calc(50% - 10px);
      height: 150px;
      margin: 20px;
      border: none;
      box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.7s ease;
      overflow: hidden;

    }

    .half-width:hover {
      transform: scale(1.03);
      background-color: #f2f4f8;
    }


    @media (max-width: 768px) {
      .con_small {
        flex-wrap: wrap;
      }

      .half-width {
        width: calc(50% - 20px);
        margin: 10px;
      }
    }

    .line2 {
      background-color: #f2f4f8;
      height: 80px;
      margin: 28px;
      padding: 20px;
      border: none;
      box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.7s ease;
      overflow: hidden;

    }

    .Inverter1 {
      height: auto;
      background-color: #f2f4f8;
      margin: 24px;
      padding: 10px;
      border: none;
      box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.7s ease;
      overflow: hidden;
    }

    .graphdiv1 {
      display: flex;
    }

    .chart1 {
      height: auto;
      background-color: #f2f4f8;
      margin: 28px;
      padding: 20px;
      border: none;
      box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.7s ease;
      overflow: hidden;
    }

    .chart2 {
      height: auto;
      background-color: #f2f4f8;
      margin: 28px;
      padding: 20px;
      width: 50%;
      border: none;
      box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.7s ease;
      overflow: hidden;
    }

    @media(max-width:576px) {
      .Inverter1 {
        height: auto;
        background-color: #f2f4f8;
        width: 100%;
        border: none;
        box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.7s ease;
        overflow: hidden;
      }

      .graphdiv1 {
        display: block
      }


      .chart2 {
        height: auto;
        background-color: #f2f4f8;
        width: 95%;
        border: none;
        box-shadow: 10px 10px 10px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.7s ease;
        overflow: hidden;
      }
    }
  </style>
</head>

<body>
  <div id="main">
    <div class="nav" style="width: 100%; margin-left: -20px;">
      <span style="cursor:pointer; margin: 15px" onclick="openNav()">&#9776;</span>
      <div class="name"><a href="{{ url_for('dash')}}">Inverter Analytics</a></div>
      <ul>
        <a href="{{url_for('dash')}}"><img src="/static/logo.jpeg/" class="logo" alt="LOGO" /></a>
      </ul>
    </div>

    <div id="mySidenav" class="sidenav" style="z-index: 10;">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <a href="{{ url_for('dash')}}">Home</a>
      <a href="{{ url_for('data_table')}}">Table</a>
      <a href="#" id="logout-btn">Log Out</a>
    </div>

    <div class="battery-container">
      <div class="battery-overlay" id="batteryOverlay"></div>
      <div class="battery-inner"></div>
      <h5 class="battery-text" id="batteryPercentage">70%</h5>
    </div>

    <!-- DC DATA -->
    <h3 style="display: flex; justify-content: center;"><u><b>DC Data</b> || LAST PACKET : {{Dccurrent[1]}}</u></h3>
    <div class="con_small">
      <div class="half-width " style="text-align: center;">

        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center mt-2">{{Dccurrent[0]}}
          <span class=" ms-2 mt-4" style="font-size:18px">A</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>DC Current </b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Dccurrent[4]}}
          <span class="mt-4 ms-2" style="font-size:15px">V</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>DC Voltage</b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Dccurrent[3]}}
          <span class="mt-4 ms-2" style="font-size:15px">°C</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Temperature</b></div>
      </div>
    </div>
    <div class="con_small">
      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Dccurrent[2]}}
          <span class="mt-4 ms-2" style="font-size:15px">W</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Input Power</b></div>
      </div>
      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Dccurrent[5]}}
          <span class="mt-4 ms-2" style="font-size:15px">W</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Cal. Power</b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{ Dccurrent[7] }}
          <span class=" ms-1" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Error</b></div>
      </div>
    </div>

    <div class="con_small">
      <div class="half-width " style="text-align: center;">
        {{dc_kwh[1]}} - {{dc_kwh[2]}}
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;"
          class="text-center mt-2">{{dc_kwh[0] if dc_kwh[0] is not none else 'N/A'}}
          <span class=" ms-2 mt-4" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>KWH (per Interval Hour) </b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{dc_total_kwh_value}}
          <span class=" ms-1" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>KWH (24 Hours) </b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{dc_total_unit[0]}}
          <span class=" ms-1" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Total units Generated </b></div>
      </div>
    </div>
    <hr>

    <!-- AC DATA -->
    <h3 style="display: flex; justify-content: center;"><u><b>AC Data</b> || LAST PACKET : {{Accurrent[1]}}</u></h3>
    <div class="con_small">
      <div class="half-width " style="text-align: center;">

        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center mt-2">{{Accurrent[0]}}
          <span class=" ms-2 mt-4" style="font-size:18px">A</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>AC Current </b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Accurrent[4]}}
          <span class="mt-4 ms-2" style="font-size:15px">V</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>AC Voltage</b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Accurrent[3]}}
          <span class="mt-4 ms-2" style="font-size:15px">°C</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Temperature</b></div>
      </div>
    </div>
    <div class="con_small">
      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Accurrent[2]}}
          <span class="mt-4 ms-2" style="font-size:15px">W</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Output Power</b></div>
      </div>
      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{Accurrent[5]}}
          <span class="mt-4 ms-2" style="font-size:15px">W</span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Cal. Power</b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{ Accurrent[7] }}
          <span class=" ms-1" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Error</b></div>
      </div>
    </div>

    <div class="con_small">
      <div class="half-width " style="text-align: center;">
        {{ac_total_kwh[1]}} - {{ac_total_kwh[2]}}
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;"
          class="text-center mt-2">{{ac_total_kwh[0] if ac_total_kwh[0] is not none else 'N/A'}}
          <span class=" ms-2 mt-4" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>KWH (per Interval Hour) </b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{total_kwh_value}}
          <span class=" ms-1" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>KWH (24 Hours) </b></div>
      </div>

      <div class="half-width">
        <br>
        <span style=" font-size: 40px;display: flex; justify-content: center;" class="text-center">{{total_unit[0]}}
          <span class=" ms-1" style="font-size:18px"></span> </span> <br>
        <div class="text-center" style="margin-bottom: 15px;"><b>Total units Consumed </b></div>
      </div>
    </div>

    <!-- Graphs -->
    <div class="chart1">
      <h5>AC Current, Ac Voltage & Power vs. Time </h5>
      <canvas id="live2" width="1400" height="430"></canvas>
    </div>

    <div class="chart1">
      <h5>DC Current, Dc Voltage & Power vs. Time</h5>
      <canvas id="live1" width="1400" height="450"></canvas>
    </div>

    <!-- Alert -->
    <div class="line2">
      <h5>Smart Alerts</h5>
    </div>
    <br>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- script for battery -->
  <script>
    let batteryLevel = 90;

    document.getElementById('batteryOverlay').style.setProperty('--battery-level', batteryLevel);
    document.getElementById('batteryPercentage').innerText = batteryLevel + '%';

    const batteryOverlay = document.getElementById('batteryOverlay');
    if (batteryLevel > 50) {
      batteryOverlay.style.background = `conic-gradient(green 0deg, green calc(3.6deg * ${batteryLevel}), #222 calc(3.6deg * ${batteryLevel}), #222 360deg)`;
    } else if (batteryLevel > 20) {
      batteryOverlay.style.background = `conic-gradient(yellow 0deg, yellow calc(3.6deg * ${batteryLevel}), #222 calc(3.6deg * ${batteryLevel}), #222 360deg)`;
    } else {
      batteryOverlay.style.background = `conic-gradient(red 0deg, red calc(3.6deg * ${batteryLevel}), #222 calc(3.6deg * ${batteryLevel}), #222 360deg)`;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script>
    function openNav() {
      document.getElementById("mySidenav").style.width = "250px";
      document.getElementById("main").style.marginLeft = "250px";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
      document.getElementById("main").style.marginLeft = "0";
    }
  </script>

  <!--live dc -->
  <script>
    const id = '{{Dccurrent[6]}}'; // Assuming this is correctly set in your template
let chart4 = null;

function livegraphDc() {
  fetch(`/livegraphdc/${id}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (!Array.isArray(data)) {
        throw new Error("Data is not an array.");
      }

      const now = new Date();
      const last24Hours = new Date(now.getTime() - 24 * 60 * 60 * 1000);

      const filteredData = data.filter(item => new Date(item.timestamp) >= last24Hours);

      const labels = filteredData.map(item => new Date(item.timestamp));
      const voltageValues = filteredData.map(item => item.Dc_Voltage);
      const currentValues = filteredData.map(item => item.Dc_Current);
      const powerValues = filteredData.map(item => item.Dc_Voltage * item.Dc_Current);

      if (chart4) {
        chart4.destroy();
      }

      const ctx = document.getElementById('live1').getContext('2d');
      chart4 = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'DC Voltage (V)',
              data: voltageValues,
              borderColor: '#56ccf0',
              backgroundColor: 'rgba(0, 0, 0, 0)',
              borderWidth: 2,
              fill: false,
              tension: 0.3
            },
            {
              label: 'DC Current (A)',
              data: currentValues,
              borderColor: '#f05c56',
              backgroundColor: 'rgba(0, 0, 0, 0)',
              borderWidth: 2,
              fill: false,
              tension: 0.3
            },
            {
              label: 'Power (W)',
              data: powerValues,
              borderColor: '#f0d756',
              backgroundColor: 'rgba(0, 0, 0, 0)',
              borderWidth: 2,
              fill: false,
              tension: 0.3
            }
          ]
        },
        options: {
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                tooltipFormat: 'MMM d, h:mm a'
              },
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Values (Voltage in V, Current in A, Power in W)'
              }
            }
          }
        }
      });
    })
    .catch(error => {
      console.error('Error fetching graph data:', error);
    });
}

livegraphDc();

    // Alternatively, use setInterval to keep calling it every second
    // setInterval(() => {
    //   livegraphDc();
    // }, 1000);
  </script>

  <!--live Ac -->
  <script>
    const id1 = '{{Accurrent[6]}}'
    let chart5 = null;
    function livegraphAc() {
      fetch(`/livegraphac/${id1}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (!Array.isArray(data)) {
            throw new Error("Data is not an array.");
          }

          const labels = data.map(item => new Date(item.timestamp));
          const voltageValues = data.map(item => item.Voltage);
          const currentValues = data.map(item => item.Current);
          const powerValues = data.map(item => item.Voltage * item.Current);

          if (chart5) {
            chart5.destroy();
          }

          const ctx = document.getElementById('live2').getContext('2d');
          chart5 = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'AC Voltage (V)',
                  data: voltageValues,
                  borderColor: '#56ccf0',
                  backgroundColor: 'rgba(0, 0, 0, 0)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.3
                },
                {
                  label: 'AC Current (A)',
                  data: currentValues,
                  borderColor: '#f05c56',
                  backgroundColor: 'rgba(0, 0, 0, 0)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.3
                },
                {
                  label: 'Power (W)',
                  data: powerValues,
                  borderColor: '#00b894',
                  backgroundColor: 'rgba(0, 0, 0, 0)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.3
                }
              ]
            },
            options: {
              scales: {
                x: {
                  type: 'time',
                  time: {
                    unit: 'hour',
                    tooltipFormat: 'MMM d, h:mm a'
                  },
                  grid: {
                    display: false
                  }
                },
                y: {
                  beginAtZero: true,
                  grid: {
                    display: false
                  },
                  title: {
                    display: true,
                    text: 'Values (Voltage in V, Current in A, Power in W)'
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching graph data:', error);
        });
    }

    livegraphAc();

    // Optionally, you can keep refreshing the graph data every second
    // setInterval(() => {
    //    livegraphAc();
    // }, 1000);

  </script>

  <!-- script for logout -->
  <script>
    document.getElementById('logout-btn').addEventListener('click', function (event) {
      event.preventDefault();
      window.location.href = "{{ url_for('logout') }}";
    });
  </script>

  <!-- script for session out automatically -->
  <script>
    var timeout;
    var logoutTime = 30 * 60 * 1000; // 30 minutes in milliseconds

    function resetTimer() {
      clearTimeout(timeout);
      timeout = setTimeout(logout, logoutTime);
    }

    function logout() {
      window.location.href = "{{ url_for('logout') }}";
    }

    document.onload = resetTimer;
    document.onmousemove = resetTimer;
    document.onkeypress = resetTimer;

    // Initial call to start the timer
    resetTimer();
  </script>
</body>
</html>